##### 스레드는 데이터, 힙 공유 - 스택은 별도

##### 하이퍼스레딩: 멀티스레드 프로그래밍에 효과적

## 멀티스레드 프로그래밍에서 고려할 점

1. Identifying Tasks: 어떤 job을 하나의 스레드로 할 것인가? Data Dependency 영향도 고려
* 메인 스레드는 파일 입출력(버퍼 관리), 오디오 디코딩, 비디오 디코딩 스레드 별도로, 디코딩된 데이터를 출력하는 스레드(타이머가 타이밍 관리)
2. Balancing: 스레드끼리 컴퓨터 자원 사용량이 비슷해야 함. 밸런스가 서로 다르면 이를 보완하기 위한 우선권 설정이 필요함.
3. Data Spliting: 스레드별 데이터 분리
4. Data Dependency: 데이터 동기화가 중요함
5. Testing and Debugging: 스레드는 테스트가 어려움

* Preemption: 뮤텍스, 세마포어 등의 자료구조 또는 크리티컬 섹션 중 어떤 것을 사용할 것인가?

## Parallelism

1. Data Parallelism: 서로 다른 데이터를 동시에 계산(GPU, 영상신호처리)
2. Task Parallelism: 같은 데이터에 대해 다른 연산
* 데이터에 대해 서로 다른 연산 후 결과 중에 하나를 선택하기

`내 프로그램이 어떤 병렬처리를 많이 가지고 있는가?`

## Kernel Thread

OS의 kernel thread(OS가 관리하는 스레드) <-> user thread

Kernel thread와 user thread가 매핑되어 있고 OS는 커널 스레드만 관리한다. 어떤 커널 스레드를 실행한다면 그 스레드에 매핑된 유저 스레드를 실행하는 것.

1. MTO, OTO, 하이브리드 모델이 있음
2. 요즘은 다 OTO 모델

영상 전송 서버에서 영상 요청이 오면 스레드 3개(파일 입출력, 패킹, 전송) 만들어서 보냄 - 요청이 동시에 1000개 오면 3000개 스레드를 만들어야만 할까?

```
darwin 서버 연구(SK): CPU가 8개 달린 하드웨어

1. 테스크 큐 스레드를 cpu만큼 만들어서 서비스 처리 메인 스레드(서비스 받기)로 사용 - 영상을 패킷으로 만들고 타이밍 정리
2. 샌더 스레드는 타이밍에 맞게 전송함
```

## 스레드 라이브러리

1. P스레드
2. 윈도우 스레드 라이브러리
3. 자바 라이브러리

`자주 반복되는 작업은 블락킹 반복되지 않으면 논블락킹`

## 스레드 프로그래밍 팁

* fork - join: 스레드들은 fork로 분기되고 join으로 병합됨

* 스레드는 글로벌 변수를 공유함, 하지만 글로벌 변수보다 스레드끼리 포인터(힙에 존재)를 만들어서 주고받으며 관리가능

* thread pool pattern: 데이터 병렬처리할 때 좋음. 같은 스레드를 여러 개 만들고 서로 다른 데이터를 처리하게 만들어준다

* 콜백 함수로 멀티프로세스를 부르면 cpu, gpu 동시에 사용할 수 있음 (concurrent programming)

* 스레드 풀을 이용해서 여러 요청 처리... 스레드가 없으면 요청은 대기(스레드를 무한정 만들지 않는다!)

## 스레드 관련 코드

* OpenMP: 라이브러리, 엄청 파워풀하지는 않음
    * `#pregma`: 컴파일러 옵션(컴파일러 디렉티브) - 컴파일러가 코드 분석해서 병렬처리함

* GCD(grand control dispatch): c extension(Apple)
    * 데이터 블락: 하나의 블락으로 인지해서 GCD가 블락 단위로 병렬처리함 - ^{ } 으로 구분

```
GCD가 사용하는 2가지 종류의 큐
concurrent queue: 동시처리 큐
serial queue: 순서대로 처리하는 큐
```

## 멀티스레드 프로그래밍 이슈

1. fork() - 스레드 카피할 것인가 아니면 프로세스를 카피할 것인가?

2. 리소스 쉐어를 어디까지 할 것인가

3. 시그널: 멀티스레드에서 시그널은 어떤 스레드에 주어야 하느냐?
    1. 하나의 스레드
    2. 프로세스의 모든 스레드
    3. 시그널을 처리하는 별도의 스레드

4. 스레드 캔슬레이션: 스레드 비정상 종료되었더라도 스레드를 바로 없애면 안된다 - 쉐어 리소스 정리가 안된다

`Deferred cancellation: 스레드를 만든 프로세스가 끝날 때까지 지우지 않는다`

5. LMP(Light Weight Process): 스레드, 커널스레드 매핑정보를 저장하는 자료구조, 윈도우, 리눅스마다 서로 다른 자료구조를 가지고 있음 - 어떻게 blocking을 구현할 것인가